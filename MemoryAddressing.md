# Memory addressing

以下80x86プロセッサのお話

## メモリアドレスの種類

+ 論理アドレス (Logical Address)  
セグメントとオフセットのペア。  
https://en.wikipedia.org/wiki/Logical_address


+ リニアアドレス (Linear Address)  
https://wa3.i-3-i.info/word14344.html  
プログラムから見たメモリアドレス。  
0x00000000から0xffffffffまで

+ 物理アドレス (Physical Address)  
https://en.wikipedia.org/wiki/Physical_address  
ハードウェアのメモリアドレス。  
メモリチップのアドレスピンを指定する際に用いる  
unsigned 32 bit or 36 bit


論理アドレス、リニアアドレスは実際のメモリではないので Virtual Address である。  
使用時に物理アドレスにマッピングされる。



このマッピングはMemory Management Unit (MMU)によって行われる。  
https://en.wikipedia.org/wiki/X86_memory_segmentation  

まず論理アドレスがリニアアドレスに変換される。  
これはセグメンテーション回路という回路によって行われる。

その後、リニアアドレスが物理アドレスに変換される。  
この操作はページング回路という回路で行われる。

## セグメントって何？  
https://ja.wikipedia.org/wiki/%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E6%96%B9%E5%BC%8F

## セグメントセレクタ  
16 bitでセグメントの場所を示す。  

Index: 13bit => セグメントディスクリプタが存在するテーブル内での場所を示す  
Table Indicator (TI): 1bit => 0ならグローバル (GDT)、1ならローカル (LDT) を参照する
Request Privilege Level (RPL): 2bit => cs レジスタに読み込んだ時の権限を表す。

セグメントディスクリプタセレクタのが、名前正しくない・・？

## セグメントディスクリプタ
セグメントのメタ情報を表す。  
Global Descriptor Table (RDT)、もしくはプロセス固有のLocal Descriptor Table (LDT) のどちらかに保存される。　　

GDTのアドレスとサイズは gftrレジスタに、LDTのアドレスとサイズは ldtrに保存される。

中にはセグメントのリニアアドレス、種類、システム由来かどうか、DPLと呼ばれる権限などが保存されている。

セグメントディスクリプタがあれば、指定したセグメントがどのリニアアドレスかが分かる。

 ## セグメントレジスタ
全６種類あり、セグメントセレクタを保存する。 

+ cs (code segment)  
コード部分のセグメントセレクタを保持する

+ ss (stack segment)  
スタック部分のセグメントセレクタを保持する

+ ds (data segment)  
データ部分のセグメントセレクタを保持する

上の3つのセグメントが分かれば、データとスタック、コードがあるので、プログラムを実行することが可能。


下の３つはよくわからない
+ es (extra segment)  
ds が足りなくなった時につかうっぽい


+ fs
+ gs


## 論理アドレスからリニアアドレスになるまで

まず論理アドレスは、セグメントセレクタと、リニアアドレスのオフセットのペアである。

1. セグメントセレクタの TI の値によって、GDTかLDTどちらかを見るか決める
2. セグメントセレクタの Index の値によって、テーブルに保存されているセグメンディスクリプタを取得
3. セグメントディスクリプタは、指定したセグメントのリニアアドレスの先頭を持っている
4. リニアアドレスのオフセットは論理アドレスに含まれているので、先頭 + オフセットで具体的なリニアアドレスが取得可能